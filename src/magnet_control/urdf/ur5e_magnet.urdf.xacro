<?xml version="1.0"?>
<robot xmlns:xacro="http://www.ros.org/wiki/xacro" name="ur5e_magnet">

  <!-- UR5e DH Parameters (standard) -->
  <xacro:property name="d1"  value="0.1625"/>
  <xacro:property name="a2"  value="-0.4250"/>
  <xacro:property name="a3"  value="-0.3922"/>
  <xacro:property name="d4"  value="0.1333"/>
  <xacro:property name="d5"  value="0.0997"/>
  <xacro:property name="d6"  value="0.0996"/>

  <!-- Joint limits -->
  <xacro:property name="effort_limit" value="150.0"/>
  <xacro:property name="velocity_limit" value="3.14"/>

  <!-- Macro for revolute joint -->
  <xacro:macro name="ur_joint" params="name parent child origin_xyz origin_rpy axis lower upper">
    <joint name="${name}" type="revolute">
      <parent link="${parent}"/>
      <child link="${child}"/>
      <origin xyz="${origin_xyz}" rpy="${origin_rpy}"/>
      <axis xyz="${axis}"/>
      <limit lower="${lower}" upper="${upper}" effort="${effort_limit}" velocity="${velocity_limit}"/>
      <dynamics damping="0.5" friction="0.1"/>
    </joint>
  </xacro:macro>

  <!-- Macro for link with cylinder visual -->
  <xacro:macro name="ur_link" params="name length radius mass color_r color_g color_b">
    <link name="${name}">
      <visual>
        <geometry>
          <cylinder length="${length}" radius="${radius}"/>
        </geometry>
        <origin xyz="0 0 ${length/2}" rpy="0 0 0"/>
        <material name="${name}_mat">
          <color rgba="${color_r} ${color_g} ${color_b} 1.0"/>
        </material>
      </visual>
      <collision>
        <geometry>
          <cylinder length="${length}" radius="${radius}"/>
        </geometry>
        <origin xyz="0 0 ${length/2}" rpy="0 0 0"/>
      </collision>
      <inertial>
        <mass value="${mass}"/>
        <origin xyz="0 0 ${length/2}"/>
        <inertia ixx="${mass*(3*radius*radius + length*length)/12}" ixy="0" ixz="0"
                 iyy="${mass*(3*radius*radius + length*length)/12}" iyz="0"
                 izz="${mass*radius*radius/2}"/>
      </inertial>
    </link>
  </xacro:macro>

  <!-- World / base -->
  <link name="world"/>

  <joint name="world_to_base" type="fixed">
    <parent link="world"/>
    <child link="base_link"/>
    <origin xyz="0 0 0" rpy="0 0 0"/>
  </joint>

  <link name="base_link">
    <visual>
      <geometry>
        <cylinder length="0.015" radius="0.075"/>
      </geometry>
      <origin xyz="0 0 0.0075" rpy="0 0 0"/>
      <material name="base_mat">
        <color rgba="0.2 0.2 0.2 1.0"/>
      </material>
    </visual>
    <collision>
      <geometry>
        <cylinder length="0.015" radius="0.075"/>
      </geometry>
      <origin xyz="0 0 0.0075" rpy="0 0 0"/>
    </collision>
    <inertial>
      <mass value="4.0"/>
      <origin xyz="0 0 0.0075"/>
      <inertia ixx="0.006" ixy="0" ixz="0" iyy="0.006" iyz="0" izz="0.011"/>
    </inertial>
  </link>

  <!-- Link 1: Shoulder -->
  <xacro:ur_link name="shoulder_link" length="${d1}" radius="0.060" mass="3.761" color_r="0.7" color_g="0.7" color_b="0.7"/>
  <xacro:ur_joint name="shoulder_pan_joint" parent="base_link" child="shoulder_link"
                  origin_xyz="0 0 0.015" origin_rpy="0 0 0" axis="0 0 1"
                  lower="-6.2832" upper="6.2832"/>

  <!-- Link 2: Upper arm -->
  <link name="upper_arm_link">
    <visual>
      <geometry>
        <cylinder length="${-a2}" radius="0.054"/>
      </geometry>
      <origin xyz="0 0 ${-a2/2}" rpy="0 0 0"/>
      <material name="upper_arm_mat">
        <color rgba="0.0 0.4 0.7 1.0"/>
      </material>
    </visual>
    <collision>
      <geometry>
        <cylinder length="${-a2}" radius="0.054"/>
      </geometry>
      <origin xyz="0 0 ${-a2/2}" rpy="0 0 0"/>
    </collision>
    <inertial>
      <mass value="8.058"/>
      <origin xyz="0 0 ${-a2/2}"/>
      <inertia ixx="0.138" ixy="0" ixz="0" iyy="0.138" iyz="0" izz="0.012"/>
    </inertial>
  </link>
  <xacro:ur_joint name="shoulder_lift_joint" parent="shoulder_link" child="upper_arm_link"
                  origin_xyz="0 0 ${d1}" origin_rpy="0 ${pi/2} 0" axis="0 1 0"
                  lower="-6.2832" upper="6.2832"/>

  <!-- Link 3: Forearm -->
  <link name="forearm_link">
    <visual>
      <geometry>
        <cylinder length="${-a3}" radius="0.042"/>
      </geometry>
      <origin xyz="0 0 ${-a3/2}" rpy="0 0 0"/>
      <material name="forearm_mat">
        <color rgba="0.0 0.4 0.7 1.0"/>
      </material>
    </visual>
    <collision>
      <geometry>
        <cylinder length="${-a3}" radius="0.042"/>
      </geometry>
      <origin xyz="0 0 ${-a3/2}" rpy="0 0 0"/>
    </collision>
    <inertial>
      <mass value="2.846"/>
      <origin xyz="0 0 ${-a3/2}"/>
      <inertia ixx="0.031" ixy="0" ixz="0" iyy="0.031" iyz="0" izz="0.003"/>
    </inertial>
  </link>
  <xacro:ur_joint name="elbow_joint" parent="upper_arm_link" child="forearm_link"
                  origin_xyz="0 0 ${-a2}" origin_rpy="0 0 0" axis="0 1 0"
                  lower="-3.14159" upper="3.14159"/>

  <!-- Link 4: Wrist 1 -->
  <xacro:ur_link name="wrist_1_link" length="${d4}" radius="0.038" mass="1.37" color_r="0.3" color_g="0.3" color_b="0.3"/>
  <xacro:ur_joint name="wrist_1_joint" parent="forearm_link" child="wrist_1_link"
                  origin_xyz="0 0 ${-a3}" origin_rpy="0 ${pi/2} 0" axis="0 1 0"
                  lower="-6.2832" upper="6.2832"/>

  <!-- Link 5: Wrist 2 -->
  <xacro:ur_link name="wrist_2_link" length="${d5}" radius="0.038" mass="1.30" color_r="0.3" color_g="0.3" color_b="0.3"/>
  <xacro:ur_joint name="wrist_2_joint" parent="wrist_1_link" child="wrist_2_link"
                  origin_xyz="0 0 ${d4}" origin_rpy="0 0 0" axis="0 0 1"
                  lower="-6.2832" upper="6.2832"/>

  <!-- Link 6: Wrist 3 -->
  <xacro:ur_link name="wrist_3_link" length="${d6}" radius="0.038" mass="0.365" color_r="0.3" color_g="0.3" color_b="0.3"/>
  <xacro:ur_joint name="wrist_3_joint" parent="wrist_2_link" child="wrist_3_link"
                  origin_xyz="0 0 ${d5}" origin_rpy="0 0 0" axis="0 1 0"
                  lower="-6.2832" upper="6.2832"/>

  <!-- Tool0 (TCP) frame -->
  <link name="tool0"/>
  <joint name="wrist_3_to_tool0" type="fixed">
    <parent link="wrist_3_link"/>
    <child link="tool0"/>
    <origin xyz="0 0 ${d6}" rpy="${-pi/2} 0 0"/>
  </joint>

  <!-- Permanent magnet attached to tool0 -->
  <link name="magnet_link">
    <visual>
      <geometry>
        <cylinder length="0.04" radius="0.015"/>
      </geometry>
      <origin xyz="0 0 0.02" rpy="0 0 0"/>
      <material name="magnet_mat">
        <color rgba="0.8 0.1 0.1 1.0"/>
      </material>
    </visual>
    <collision>
      <geometry>
        <cylinder length="0.04" radius="0.015"/>
      </geometry>
      <origin xyz="0 0 0.02" rpy="0 0 0"/>
    </collision>
    <inertial>
      <mass value="0.2"/>
      <origin xyz="0 0 0.02"/>
      <inertia ixx="0.00004" ixy="0" ixz="0" iyy="0.00004" iyz="0" izz="0.00002"/>
    </inertial>
  </link>
  <joint name="tool0_to_magnet" type="fixed">
    <parent link="tool0"/>
    <child link="magnet_link"/>
    <origin xyz="0 0 0" rpy="0 0 0"/>
  </joint>

  <!-- Gazebo ros2_control plugin -->
  <ros2_control name="ur5e_magnet_system" type="system">
    <hardware>
      <plugin>gazebo_ros2_control/GazeboSystem</plugin>
    </hardware>
    <joint name="shoulder_pan_joint">
      <command_interface name="position"><param name="min">-6.2832</param><param name="max">6.2832</param></command_interface>
      <state_interface name="position"/><state_interface name="velocity"/>
    </joint>
    <joint name="shoulder_lift_joint">
      <command_interface name="position"><param name="min">-6.2832</param><param name="max">6.2832</param></command_interface>
      <state_interface name="position"/><state_interface name="velocity"/>
    </joint>
    <joint name="elbow_joint">
      <command_interface name="position"><param name="min">-3.14159</param><param name="max">3.14159</param></command_interface>
      <state_interface name="position"/><state_interface name="velocity"/>
    </joint>
    <joint name="wrist_1_joint">
      <command_interface name="position"><param name="min">-6.2832</param><param name="max">6.2832</param></command_interface>
      <state_interface name="position"/><state_interface name="velocity"/>
    </joint>
    <joint name="wrist_2_joint">
      <command_interface name="position"><param name="min">-6.2832</param><param name="max">6.2832</param></command_interface>
      <state_interface name="position"/><state_interface name="velocity"/>
    </joint>
    <joint name="wrist_3_joint">
      <command_interface name="position"><param name="min">-6.2832</param><param name="max">6.2832</param></command_interface>
      <state_interface name="position"/><state_interface name="velocity"/>
    </joint>
  </ros2_control>

  <gazebo>
    <plugin filename="libgazebo_ros2_control.so" name="gazebo_ros2_control">
      <robot_param>robot_description</robot_param>
      <robot_param_node>robot_state_publisher</robot_param_node>
      <parameters>/home/user/magnetcontrol_ws/src/magnet_control/config/ur5e_controllers.yaml</parameters>
    </plugin>
  </gazebo>

</robot>
